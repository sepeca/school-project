<style>
    #chat-box {
        height: 300px;
        overflow-y: scroll;
        border: 1px solid #ccc;
        padding: 10px;
        background-color: #fff;
    }

    .in {
        text-align: left;
        background-color: #e0f7fa;
        padding: 5px;
        margin: 5px;
        border-radius: 5px;
    }

    .out {
        text-align: right;
        background-color: #c8e6c9;
        padding: 5px;
        margin: 5px;
        border-radius: 5px;
    }

    small {
        display: block;
        font-size: 12px;
        color: #888;
    }
</style>

<div id="chat-box" data-student-id="{{ student_id }}">
    {% if student %}
    <p>Выбран: <b>{{ student.last_name }} {{ student.first_name }}</b></p>
    {% else %}
    <p id="no-student-message">Ученик не выбран, кликните на его имя в таблице.</p>
    {% endif %}

</div>


<div style="margin-top: 10px;">
    <input type="text" id="message-input" placeholder="Введите сообщение...">
    <button id="send-button">Отправить</button>
</div>


<script>

    function initializeChat() {
        console.log('Скрипт чата инициализирован'); // Проверка

        const chatBox = document.getElementById('chat-box');
        const studentId = chatBox.getAttribute('data-student-id');
        console.log(studentId)

        const inputField = document.getElementById('message-input');
        if (inputField) {
            console.log('inputfield na meste')
        }
        let lastTimestamp = '';

        const sentMessageTimestamps = new Set();

        // Автоматический скролл к последнему сообщению
        function scrollToBottom() {
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // Преобразование UTC в локальное время
        function formatToLocalTime(utcDateTime) {
            const date = new Date(utcDateTime);
            return new Intl.DateTimeFormat('default', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).format(date);
        }

        function renderMessage(msg) {
            const div = document.createElement('div');
            div.classList.add(msg.direction);

            // Преобразуем время к локальному
            const localTime = formatToLocalTime(msg.timestamp);

            if (msg.direction === 'in') {
                div.innerHTML = `<b>${msg.user}:</b> ${msg.message} <small>${localTime}</small>`;
            } else {
                div.innerHTML = `${msg.message} <small>${localTime}</small>`;
            }

            chatBox.appendChild(div);
            scrollToBottom();
        }


        // Хранит уже отображённые timestamps

        function fetchMessages() {
            if (!studentId) return;

            fetch(`/get_messages/${studentId}/?last_timestamp=${lastTimestamp}`)
                .then(response => response.json())
                .then(data => {
                    let newLastTimestamp = lastTimestamp;

                    data.messages.forEach(msg => {
                        // Если сообщение уже было отображено, пропускаем
                        if (sentMessageTimestamps.has(msg.timestamp)) return;

                        renderMessage(msg);
                        sentMessageTimestamps.add(msg.timestamp);

                        // Обновляем timestamp только после обработки всех сообщений
                        newLastTimestamp = msg.timestamp;
                    });

                    // Устанавливаем новый lastTimestamp только после обработки всех сообщений
                    lastTimestamp = newLastTimestamp;
                })
                .finally(() => setTimeout(fetchMessages, 3000)); // Повторный запрос через 3 секунды
        }

        // Отправка сообщения
        document.addEventListener('click', function (e) {
            if (e.target && e.target.id === 'send-button') {


                const csrfToken = '{{ csrf_token }}';

                if (!studentId) {
                    return;
                }

                const message = inputField.value.trim();
                if (!message) {
                    return;
                }

                fetch(`/send_message/${studentId}/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Accept': 'application/json',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `message=${encodeURIComponent(message)}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok') {
                            inputField.value = '';
                            lastTimestamp = '';
                            fetchMessages();
                        } else {
                            console.error('Ошибка отправки сообщения');
                        }
                    })
                    .catch(error => console.error('Ошибка:', error));
            }
        });

        // Инициализация получения сообщений при загрузке
        if (studentId) {
            fetchMessages();
        }
    }
</script>


